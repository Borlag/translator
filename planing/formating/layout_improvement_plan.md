# План улучшений автоформатирования DOCX (без ручной верстки)

## Цель
Сделать так, чтобы переведенный `.docx` выходил как готовый продукт: без обрезки текста, наложений, «скрытых» строк в таблицах/фреймах и без ручной доводки человеком.

## Что выявлено
1. В текущем прогоне были отключены ключевые режимы лечения верстки: `abbyy_profile=off`, `layout_check=false`, `layout_auto_fix=false`, `mode=reflow`.
2. В документе много жестких ABBYY-ограничений (`framePr`, `trHeight exact`, `lineSpacing exact`), которые и вызывают скрытый/обрезанный текст после EN->RU расширения.
3. Визуально подтверждены дефекты в таблицах и на плотных страницах: часть текста уходит за контейнеры.

## Стратегия реализации

### Этап 1. Быстрый прод-результат (1-2 дня)
1. Включить безопасный профиль форматирования по умолчанию для ABBYY-доков:
   - `mode: com`
   - `abbyy_profile: safe`
   - `layout_check: true`
   - `layout_auto_fix: true`
   - `font_shrink_table_pt: 0.3-0.5`
   - `layout_spacing_factor: 0.90-0.93`
2. Это даст заметное снижение обрезки без сильного развала пагинации.

### Этап 2. Точечный ремонт фреймов/таблиц (3-5 дней)
1. Добавить детекцию `framePr`-контейнеров как отдельного типа layout-риска.
2. Добавить новый код риска: `layout_frame_overflow_risk`.
3. Применять фиксы точечно (только к рискованным сегментам), а не глобально:
   - мягкое сжатие межсимвольного/межабзацного пространства,
   - небольшой shrink шрифта,
   - безопасная переразбивка длинных строк в таблицах.

### Этап 3. Постпроцесс как отдельный системный шаг (2-3 дня)
1. Добавить отдельную команду, например:
   - `docxru postformat --input translated.docx --output final.docx --profile aviation-safe`
2. Шаг работает после перевода/checker и не требует повторного полного перевода.
3. Интегрировать шаг в пайплайн как обязательный для «тяжелых» документов.

### Этап 4. Автоконтроль качества на выходе (2-3 дня)
1. Рендер страниц `DOCX -> PDF -> PNG` в CI/локальном раннере.
2. Проверки-гейты:
   - рост страниц выше порога,
   - признаки наложений/обрезки,
   - критические отличия от baseline.
3. Если gate не пройден — запуск fallback-профиля и повторная постобработка.

## Технические варианты по стоимости

### Вариант A (рекомендуемый, экономичный)
1. Оставить текущий стек (`python-docx` + Word COM + ваши эвристики).
2. Усилить его этапами выше.
3. Даст наилучший баланс «качество/стоимость».

### Вариант B (премиум fallback)
1. Подключить коммерческий layout-движок только для проблемных файлов.
2. Использовать как fallback после неуспешного прохождения quality-gate.
3. Дороже, но полезно для документов с экстремально сложной версткой.

## Критерии готовности (Definition of Done)
1. В 95%+ документов не требуется ручная верстка.
2. Количество визуальных дефектов (обрезка/наложение) снижено минимум на 80% относительно текущего baseline.
3. Пагинация не «плывет» сверх согласованного порога.
4. Пайплайн стабильно выдает «final.docx» автоматически.

## Порядок внедрения
1. Сразу внедрить Этап 1 в рабочий конфиг.
2. Затем реализовать Этап 2 + Этап 3 в коде.
3. После этого включить Этап 4 как обязательный quality-gate.
